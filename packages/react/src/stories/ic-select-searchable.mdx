import { useState, useEffect, useRef } from "react";
import { Meta, Story, Canvas, Description } from "@storybook/blocks";
import * as IcSelectSearchableStories from './ic-select-searchable.stories';

import { IcSelect, IcButton, IcTypography } from "../components";
import {SlottedSVG} from "../react-component-lib/slottedSVG";
import readme from "../../../web-components/src/components/ic-select/readme.md";

<Meta of={IcSelectSearchableStories} />

<Description markdown={readme} />

export const defaultArgs = {
  disabled: false,
  fullWidth: false,
  helperText: "Select one option from the list",
  hideLabel: false,
  loading: false,
  loadingLabel: "Loading...",
  label: "What is your favourite coffee?",
  placeholder: "Select an option",
  readonly: false,
  required: false,
  size: 'default',
  validationStatus: "",
  validationText: "",
  includeDescriptionsInSearch: false,
  includeGroupTitlesInSearch: false,
  searchMatchPosition: "anywhere",
};

export const options = [
  { label: "Cappuccino", value: "Cap" },
  { label: "Latte", value: "Lat" },
  { label: "Americano", value: "Ame" },
  { label: "Filter", value: "Fil" },
  { label: "Flat white", value: "Fla" },
  { label: "Mocha", value: "Moc" },
  { label: "Macchiato", value: "Mac" },
];

export const optionsWithDescriptions = [
  {
    label: "Cappuccino",
    value: "Cap",
    description: "Coffee frothed up with pressurised steam",
  },
  {
    label: "Latte",
    value: "Lat",
    description: "A milkier coffee than a cappuccino",
  },
  {
    label: "Americano",
    value: "Ame",
    description: "Espresso coffee diluted with hot water",
  },
  {
    label: "Filter",
    value: "Fil",
    description: "Coffee filtered using paper or a mesh",
  },
  {
    label: "Flat white",
    value: "Fla",
    description: "Coffee without froth made with espresso and hot steamed milk",
  },
  {
    label: "Mocha",
    value: "Moc",
    description: "A mixture of coffee and chocolate",
  },
  {
    label: "Macchiato",
    value: "Mac",
    description: "Espresso coffee with a dash of frothy steamed milk",
  },
];

export const optionsWithDisabled = [
  { label: "Cappuccino", value: "Cap" },
  { label: "Latte", value: "Lat" },
  { label: "Americano", value: "Ame", disabled: true },
  { label: "Filter", value: "Fil", disabled: true },
  { label: "Flat white", value: "Fla" },
  { label: "Mocha", value: "Moc" },
  { label: "Macchiato", value: "Mac", disabled: true },
];

export const optionsWithRecommended = [
  { label: "Cappuccino", value: "Cappuccino" },
  { label: "Flat white", value: "Flat white", recommended: true },
  { label: "Latte", value: "Latte" },
  { label: "Americano", value: "Americano", recommended: true },
  { label: "Filter", value: "Fil" },
  { label: "Mocha", value: "Moc" },
  { label: "Macchiato", value: "Mac" },
];

export const playgroundOptions = [
  {
    label: "Cappuccino",
    value: "Cap",
    description: "Coffee frothed up with pressurised steam",
  },
  {
    label: "Boring",
    children: [
      {
        label: "Latte",
        value: "Lat",
        description: "A milkier coffee than a cappuccino",
      },
      {
        label: "Filter",
        value: "Fil",
        description: "Coffee filtered using paper or a mesh",
      },
    ],
  },
  {
    label: "Fancy",
    children: [
      {
        label: "Flat white",
        value: "Fla",
        description:
          "Coffee without froth made with espresso and hot steamed milk",
      },
      {
        label: "Macchiato",
        value: "Mac",
        description: "Espresso coffee with a dash of frothy steamed milk",
      },
    ],
  },
  {
    label: "Americano",
    value: "Ame",
    description: "Espresso coffee diluted with hot water",
  },
  {
    label: "Mocha",
    value: "Moc",
    description: "A mixture of coffee and chocolate",
  },
];

### Default

<Canvas>
  <Story of={IcSelectSearchableStories.Default} />
</Canvas>

### Default value

<Canvas>
  <Story of={IcSelectSearchableStories.DefaultValue} />
</Canvas>

### Filter by start of options

<Canvas>
  <Story of={IcSelectSearchableStories.FilterByStartOfOptions} />
</Canvas>

### With descriptions

<Canvas>
  <Story of={IcSelectSearchableStories.WithDescriptions} />
</Canvas>

### With descriptions (included in search)

<Canvas>
  <Story of={IcSelectSearchableStories.WithDescriptionsIncludedInSearch} />
</Canvas>

### Helper text

<Canvas>
  <Story of={IcSelectSearchableStories.HelperText} />
</Canvas>

### Sizes

<Canvas>
  <Story of={IcSelectSearchableStories.Sizes} />
</Canvas>

### Disabled

<Canvas>
  <Story of={IcSelectSearchableStories.Disabled} />
</Canvas>

### Disabled options

<Canvas>
  <Story of={IcSelectSearchableStories.DisabledOptions} />
</Canvas>

### Hidden label

<Canvas>
  <Story of={IcSelectSearchableStories.HiddenLabel} />
</Canvas>

### Required

<Canvas>
  <Story of={IcSelectSearchableStories.Required} />
</Canvas>

### Groups

<Canvas>
  <Story of={IcSelectSearchableStories.Groups} />
</Canvas>

### Groups (group titles included in search)

<Canvas>
  <Story of={IcSelectSearchableStories.GroupsGroupTitlesIncludedInSearch} />
</Canvas>

### Recommended

<Canvas>
  <Story of={IcSelectSearchableStories.Recommended} />
</Canvas>

### Validation

<Canvas>
  <Story of={IcSelectSearchableStories.Validation} />
</Canvas>

export const InForm = () => {
  return (
    <form>
      <IcSelect
        label="What is your favourite coffee?"
        required
        value="Cap"
        options={options}
        onIcChange={(event) => console.log(`icChange: ${event.detail.value}`)}
        searchable
        showClearButton
      />
      <IcButton type="reset">Reset</IcButton>
    </form>
  );
};

### Searchable Form reset default value

<Canvas>
  <Story of={IcSelectSearchableStories.SearchableFormResetDefaultValue} />
</Canvas>

### Many options

<Canvas>
  <Story of={IcSelectSearchableStories.ManyOptions} />
</Canvas>

### External filtering

export const ExternalFiltering = () => {
  const mockData = [
    { label: "Espresso", value: "Esp" },
    { label: "Double Espresso", value: "Dou" },
    { label: "Cappuccino", value: "Cap" },
    { label: "Latte", value: "Lat" },
    { label: "Americano", value: "Ame" },
    { label: "Filter", value: "Fil" },
    { label: "Flat white", value: "Fla" },
    { label: "Mocha", value: "Moc" },
    { label: "Macchiato", value: "Mac" },
  ];
  const [event, setEvent] = useState();
  const [selectedValue, setSelectedValue] = useState(null);
  const [results, setResults] = useState([]);
  const [loading, setLoading] = useState(false);
  useEffect(() => {
    const searchTerm = event?.detail.value;
    if (searchTerm !== selectedValue) {
      if (searchTerm) {
        setLoading(true);
        const mockAPI = (query) => {
          const filteredResults = mockData.filter((m) =>
            m.label.toLowerCase().includes(query.toLowerCase())
          );
          return new Promise((resolve) =>
            setTimeout(
              () => resolve(filteredResults),
              event.type === "icInput" ? 2000 : 500
            )
          );
        };
        mockAPI(searchTerm).then((results) => setResults(results));
      } else {
        setResults([]);
      }
    }
  }, [event]);
  const handleInput = (event) => {
    console.log(event.detail.value);
    setEvent(event);
  };
  const handleOptionSelect = (event) => {
    setSelectedValue(event.detail.value);
  };
  const handleClear = () => {
    setResults([]);
  };
  return (
    <IcSelect
      loading={loading}
      timeout={1000}
      debounce={300}
      label="What is your favourite coffee?"
      searchable
      disableFilter
      options={results}
      onIcOptionSelect={handleOptionSelect}
      onIcChange={handleInput}
      onIcRetryLoad={handleInput}
      onIcClear={handleClear}
    />
  );
};

<Canvas>
  <Story of={IcSelectSearchableStories.ExternalFiltering_} />
</Canvas>

### Emitting icOptionSelect on enter

<Canvas>
  <Story of={IcSelectSearchableStories.EmittingIcOptionSelectOnEnter} />
</Canvas>

### Controlled

export const ControlledExample = () => {
  const [value, setValue] = useState("Cap");
  const handleChange = (event) => {
    console.log(event.detail.value);
    setValue(event.detail.value);
  };
  return (
    <IcSelect
      searchable
      placeholder="Controlled"
      label="Controlled"
      options={options}
      value={value}
      onIcChange={handleChange}
    />
  );
};

<Canvas>
  <Story of={IcSelectSearchableStories.Controlled} />
</Canvas>

### Uncontrolled

export const Uncontrolled = () => {
  const selectEl = useRef();
  const handleChange = () => {
    console.log(selectEl.current.value);
  };
  return (
    <>
      <IcSelect
        ref={selectEl}
        searchable
        placeholder="Uncontrolled"
        label="Uncontrolled"
        options={options}
        onIcChange={handleChange}
      />
    </>
  );
};

<Canvas>
  <Story of={IcSelectSearchableStories.Uncontrolled_} />
</Canvas>

### Playground

<Canvas>
  <Story of={IcSelectSearchableStories.Playground} />
</Canvas>
